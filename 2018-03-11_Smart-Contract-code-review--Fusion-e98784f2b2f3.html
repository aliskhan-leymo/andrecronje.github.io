<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Smart Contract code review: Fusion</title><meta name="description" content="Disclaimer: These reviews are done as is from what is on display in the master branch of the repo’s made available. This review is not a…"><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Smart Contract code review: Fusion</h1>
</header>
<section data-field="subtitle" class="p-summary">
Disclaimer: These reviews are done as is from what is on display in the master branch of the repo’s made available. This review is not a…
</section>
<section data-field="body" class="e-content">
<section name="ae76" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="36b3" id="36b3" class="graf graf--h3 graf--leading graf--title">Smart Contract code review: Fusion</h3><p name="697c" id="697c" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Disclaimer</strong>: These reviews are done as is from what is on display in the master branch of the repo’s made available. This review is not a comment on the overall project, scope, or success thereof. This was done as an educational review by me and any comments in the article are simply my opinion. It should not be used as any comment or advice on the project as a whole.</p><p name="bb9a" id="bb9a" class="graf graf--p graf-after--p">I was hoping to do this review on the Fusion mainnet code, unfortunately at the time of writing it is currently not yet available. So instead I thought let’s go through the Fusion ICO smart contract.</p><p name="b7d2" id="b7d2" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Disclaimer</strong>: the following is a lot more technical than my normal reviews, I might suggest just jumping down to conclusion for the less technical inclined readers.</p><p name="bce1" id="bce1" class="graf graf--p graf-after--p">We start over at <a href="https://github.com/FUSIONFoundation/TokenSale" data-href="https://github.com/FUSIONFoundation/TokenSale" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener noopener" target="_blank">https://github.com/FUSIONFoundation/TokenSale</a></p><figure name="9a3b" id="9a3b" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 428px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 61.1%;"></div><img class="graf-image" data-image-id="1*_6NwNAxxeo43tUzSKMF4IA.png" data-width="902" data-height="551" src="https://cdn-images-1.medium.com/max/800/1*_6NwNAxxeo43tUzSKMF4IA.png"></div></figure><p name="bc91" id="bc91" class="graf graf--p graf-after--figure">Straight forward repo, we can see they are using Truffle to make their lives for deployment a bit easier. config.json holds the configuration steps required for the smart contract</p><figure name="bece" id="bece" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 409px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 58.5%;"></div><img class="graf-image" data-image-id="1*85FTtmhacbkBfXl8Od5BXQ.png" data-width="908" data-height="531" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*85FTtmhacbkBfXl8Od5BXQ.png"></div></figure><p name="925c" id="925c" class="graf graf--p graf-after--figure">We can see the Fusion token will have 57,344,000 FSN tokens total minted. The total sale amount will be 20,480,000 FSN. There will be two stages, stage one will last 86400 seconds (or 24 hours) and stage two will last 777600 seconds (or 9 days). Stage one will receive 420 tokens per ETH, and stage two will receive 400 tokens per ETH. StartTime will be 1517486400 in unix time stamp (or 02/01/2018 @ 12:00pm (UTC)), userWithdrawalDelaySec will wait 24 hours, and clearDelaySec will wait 15 days. Nothing super interesting here, but these variables will be important later.</p><p name="c415" id="c415" class="graf graf--p graf-after--p">So let’s jump into the ShareTokenSale.sol since this is the actual meat of the contract.</p><figure name="4e73" id="4e73" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 479px; max-height: 648px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 135.3%;"></div><img class="graf-image" data-image-id="1*n2WIYbtSGo0IBecAJSHeaw.png" data-width="479" data-height="648" src="https://cdn-images-1.medium.com/max/800/1*n2WIYbtSGo0IBecAJSHeaw.png"></div></figure><p name="9d0f" id="9d0f" class="graf graf--p graf-after--figure">We see the token sale inherits the Ownable interface, this interface allows for functions to be specified as owner only, this just ensures that some of the more sensitive functions can only be executed by the contract creator. The top level declarations are just variables that are going to be used, for example totalSaleAmount will be set to 20,480,000 FSN as we noted earlier in the config.json. The Stage struct will contain the two stages we noted earlier, with rate being equal to 400 or 420, duration equal to 86400 or 777600, and startTime calculated from the startTime config variable + the duration in seconds.</p><figure name="49e4" id="49e4" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 491px; max-height: 503px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 102.4%;"></div><img class="graf-image" data-image-id="1*4nawewE-eNgApn6HpCDdSA.png" data-width="491" data-height="503" src="https://cdn-images-1.medium.com/max/800/1*4nawewE-eNgApn6HpCDdSA.png"></div></figure><p name="052e" id="052e" class="graf graf--p graf-after--figure">We have some functional modifiers, these are true/false questions that you can ask before a function is fired, so if I want to call a function but it has the modifier onlyOpenTime, then it means that function can only trigger if isStarted() returns true.</p><figure name="00a5" id="00a5" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 227px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 32.4%;"></div><img class="graf-image" data-image-id="1*jG-Vr6hIM2I2rUFoCxaOZg.png" data-width="877" data-height="284" src="https://cdn-images-1.medium.com/max/800/1*jG-Vr6hIM2I2rUFoCxaOZg.png"></div></figure><p name="7430" id="7430" class="graf graf--p graf-after--figure">StartSale, nothing overly fancy here, the stages are calculated based on the data in config.json, endTime, startTime, userWithdrawalStartTime, and clearStartTime are calculated and set.</p><figure name="9c92" id="9c92" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 626px; max-height: 364px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 58.099999999999994%;"></div><img class="graf-image" data-image-id="1*UD2I_zo0KV8sBKYv7gl7OQ.png" data-width="626" data-height="364" src="https://cdn-images-1.medium.com/max/800/1*UD2I_zo0KV8sBKYv7gl7OQ.png"></div></figure><p name="8dae" id="8dae" class="graf graf--p graf-after--figure">Here we start with the first interesting bit. So the default function call is () and it calls buy(), buy is payable which means an Ether value must be sent along with the function call, and it’s onlyOpenTime, meaning that the function can only trigger if it is currently the OpenTime as calculated earlier.</p><p name="e4bf" id="e4bf" class="graf graf--p graf-after--p">First test is to see that you are sending at least greater than 0.1 ether, if not a defer message will be returned and the transaction will be cancelled.</p><p name="7620" id="7620" class="graf graf--p graf-after--p">Next we get the stage of the sale, this will be either stage one or two, this is used to calculate the amount of tokens per Ether (either 400 or 420).</p><p name="1302" id="1302" class="graf graf--p graf-after--p">After this purchaserMapping array (object containing all previously recorded purchasers) is checked if the sender already exists in the array. If it is not recorded we add it to the array, if it is already recorded we simply add another purchase. The amount of Ether sent in is added to the specific stage index for that user, and the amount of Ether sent in is added to the global amounts.</p><p name="3550" id="3550" class="graf graf--p graf-after--p">TotalWannaBuyAmount (the total amount that everyone wants to buy) is incremented with the amount of FSN that will be given for that amount of Ether sent in. And then we run _calcProportion(). Here I disagree slightly with the choice of needing to call _calcProportion() on every single purchase call, the reason this was done was so that the website in realtime could read the output of these changes. Since this requires a state change however, it means the amount of gas required to call the function is slightly more since it has to save the value to the internal storage. For this reason I would have had a non storage influencing function that could have simply been called via the call method that just returned the proportion result. Net result would have been the same and the gas cost for purchasers would have been less (although we are talking about incredibly small margins here)</p><figure name="a938" id="a938" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 594px; max-height: 152px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 25.6%;"></div><img class="graf-image" data-image-id="1*leFqOMW_mkL_ORWZU2Sm-g.png" data-width="594" data-height="152" src="https://cdn-images-1.medium.com/max/800/1*leFqOMW_mkL_ORWZU2Sm-g.png"></div></figure><p name="3a94" id="3a94" class="graf graf--p graf-after--figure">So here we see if the totalWannaBuyAmount is greater than the total sale amount. If it is not, then we can simply return a proportion of 1 (since we still have more tokens to sell than what people want to buy). If however it is greater than, then we need to take the totalSaleAmount and divide it by the totalWannaBuyAmount to arrive at the proportion. This value is very important in the next bit</p><figure name="8e46" id="8e46" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 512px; max-height: 405px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 79.10000000000001%;"></div><img class="graf-image" data-image-id="1*h2mVrJqR0l2UiG9xGJsvNQ.png" data-width="512" data-height="405" src="https://cdn-images-1.medium.com/max/800/1*h2mVrJqR0l2UiG9xGJsvNQ.png"></div></figure><p name="0001" id="0001" class="graf graf--p graf-after--figure">So now the sale has finally ended, and all of the users variables have been recorded. We know who wanted to buy, how many, and when. So all that’s left to do is to run through the array of purchasers, calculate their proportions, this is done via getSaleInto</p><figure name="d87c" id="d87c" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 673px; max-height: 293px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 43.5%;"></div><img class="graf-image" data-image-id="1*yBIBWSmkyhY8SUVGgYlPXw.png" data-width="673" data-height="293" src="https://cdn-images-1.medium.com/max/800/1*yBIBWSmkyhY8SUVGgYlPXw.png"></div></figure><p name="b7d4" id="b7d4" class="graf graf--p graf-after--figure">Here 3 variables are important, sendEther, usedEther, and getToken. sendEther is the total amount of ether sent in by the address (it is accumulated for each stage). usedEther is the actual used amount based on the proportion percentage. getToken is the amount of tokens per stage for the usedEther per stage.</p><p name="140e" id="140e" class="graf graf--p graf-after--p">These 3 variables are returned and then it is returned to the user.</p><p name="d061" id="d061" class="graf graf--p graf-after--p">Here there is actually a bug in withdrawal and how it interacts with the clear function call</p><figure name="1d0a" id="1d0a" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 291px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 41.6%;"></div><img class="graf-image" data-image-id="1*ZPFUPt07MBHVvZ39QJoTLg.png" data-width="781" data-height="325" src="https://cdn-images-1.medium.com/max/800/1*ZPFUPt07MBHVvZ39QJoTLg.png"></div></figure><p name="05d1" id="05d1" class="graf graf--p graf-after--figure">If a non purchaser were to call withdrawal it would increment the withdrawn object, meaning that purchasersAllWithdrawn could never be set to true in this case, and then clearAll could never be triggered. This however was a pointless bug, since withdrawalFor removed all the funds long before clearAll came into play.</p><p name="7451" id="7451" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Conclusion</strong>: I originally had to go through this contract 3 times, each time I was more amazed by what I saw. The code above is elegant, yet revolutionary. The concept was so simple, a mechanism by which everyone could participate, everyone guaranteed tokens, and everyone guaranteed their ethereum refund. All handled by 210 lines of code.</p><p name="b73d" id="b73d" class="graf graf--p graf-after--p">What Fusion managed to accomplish here was code that was risk free, inclusive, and fair. And never have I seen a company that has encompassed their vision so well into code. I highly recommend any ICO’s to look at this kind of model, it completely avoids the gas wars, the sell out rush, or having a disappointed community in your hands after the sale. My only real comments are; 1, Fusion listed to quickly on exchanges, it’s this idea of missing out that causes people to want to buy more and that’s when value spikes after ICO listing on exchanges, with their model, everyone that wanted to buy, managed to buy, so there wasn’t any rush to collect any more after the sale had ended. 2, the small bug in clearAll, and 3, the extra gas used for the proportion calculation that was unnecessary and could have been cheaper for their purchasers.</p><p name="1af3" id="1af3" class="graf graf--p graf-after--p graf--trailing">Still, a truly beautiful model, written with truly elegant code. I am left hungry and wanting more and hope to see their full code soon, eager with expectation.</p></div></div></section>
</section>
<footer><p class="p-tags">Tagged in <a href="https://medium.com/tag/ethereum" class="p-tag">Ethereum</a>, <a href="https://medium.com/tag/fusion" class="p-tag">Fusion</a>, <a href="https://medium.com/tag/crypto" class="p-tag">Crypto</a>, <a href="https://medium.com/tag/cryptocurrency" class="p-tag">Cryptocurrency</a>, <a href="https://medium.com/tag/review" class="p-tag">Review</a></p><p>By <a href="https://medium.com/@suchi.blackwing" class="p-author h-card">Andre Cronje</a> on <a href="https://medium.com/p/e98784f2b2f3"><time class="dt-published" datetime="2018-03-11T10:20:32.365Z">March 11, 2018</time></a>.</p><p><a href="https://medium.com/@suchi.blackwing/smart-contract-code-review-fusion-e98784f2b2f3" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on May 2, 2018.</p></footer></article>

</body></html>